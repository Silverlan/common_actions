name: 'Generic CMake build'
description: 'Builds the specified project'
inputs:
  build_type:
    description: 'Build Type'
    required: true
  build_generator:
    description: 'Build Generator'
    required: true
  build_target:
    description: 'Main target to build'
    required: true
  build_dir:
    description: 'The directory to write the build files to'
    required: true
    default: 'build'
  cmake_script_location:
    description: 'The location of the CMake script'
    required: true
    default: '.'
  cmake_definitions:
    description: 'CMake definitions'
    required: true
    default: ''
  cmake_definitions_tmp:
    description: 'Temporary CMake definitions'
    required: true
    default: ''
  cmake_var:
    description: 'Name of the CMake variable to set to the library path'
    required: true
    default: ''
runs:
  using: "composite"
  steps: 
    - name: Build
      shell: bash
      env:
        CC:   gcc-11
        CXX:  g++-11
      run: |
        GA_ROOT_DIR=$PWD
        mkdir -p ${{ inputs.build_dir }}
        cd ${{ inputs.build_dir }}
        echo "BUILD CMAKE DEFS: ${{ inputs.cmake_definitions }}"
        cmake ${{ env.GA_ROOT_DIR }}/${{ inputs.cmake_script_location }} ${{ inputs.cmake_definitions }} ${{ inputs.cmake_definitions_tmp }} -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} -G "${{ inputs.build_generator }}"
        cmake --build ./ --config ${{ inputs.build_type }} --target ${{ inputs.build_target }}
        
        newCmakeDefs=${{ env.g_cmake_defs }}
        if [[ "${{ inputs.cmake_var }}" != "" ]]; then
          $newCmakeDefs+=" -D${{ inputs.cmake_var }}=${{ env.GA_ROOT_DIR }}/${{ inputs.build_dir }}/${{ inputs.build_type }}/${{ inputs.build_target }}$GA_SHARED_LINK_LIBRARY_EXT"
        fi
        echo "g_cmake_defs=$newCmakeDefs" >> $GITHUB_ENV
        
        #if [[ "${{ inputs.cmake_var }}" != "" ]]; then
        #  echo "cmake_definitions=${{ inputs.cmake_definitions }} -D${{ inputs.cmake_var }}=${{ env.GA_ROOT_DIR }}/${{ inputs.build_dir }}/${{ inputs.build_type }}/${{ inputs.build_target }}$GA_SHARED_LINK_LIBRARY_EXT" >> $GITHUB_ENV
        #fi
